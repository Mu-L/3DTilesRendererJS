import{p as R,ag as B,k as U,af as _,n as E}from"./three.module-BB2USAyE.js";import{W as A,a as P,L as C,b as G,T as M}from"./TilesRenderer-BWSIOyW5.js";import{E as T}from"./lil-gui.module.min-D95Toaa3.js";const w=new T(A,A,P),F=new T(C,C,G);class N{constructor(){this.creditsCount={}}_adjustCredits(t,o){const n=this.creditsCount,e=t.split(/;/g);for(let a=0,m=e.length;a<m;a++){const l=e[a];l in n||(n[l]=0),n[l]+=o?1:-1,n[l]<=0&&delete n[l]}}addCredits(t){this._adjustCredits(t,!0)}removeCredits(t){this._adjustCredits(t,!1)}toString(){return Object.entries(this.creditsCount).sort((o,n)=>{const e=o[1];return n[1]-e}).map(o=>o[0]).join("; ")}}const j="https://tile.googleapis.com",V=`${j}/v1/3dtiles/root.json`,L=new R,S=new B,z=s=>class extends s{constructor(t,o=w){super(t),this.ellipsoid=o}setLatLonToYUp(t,o){const{ellipsoid:n,group:e}=this;S.set(Math.PI/2,Math.PI/2,0),L.makeRotationFromEuler(S),n.constructLatLonFrame(t,o,e.matrix).multiply(L).invert().decompose(e.position,e.quaternion,e.scale),e.updateMatrixWorld(!0)}},W=s=>class extends z(s){constructor(t=V){super(t,w),this._credits=new N,this.fetchOptions.mode="cors",this.parseQueue.maxJobs=10,this.downloadQueue.maxJobs=30,this.lruCache.minSize=3e3,this.lruCache.maxSize=5e3,this.errorTarget=40,this.addEventListener("tile-visibility-change",o=>{const{tile:n,visible:e}=o,a=n.cached.metadata.asset.copyright||"";e?this._credits.addCredits(a):this._credits.removeCredits(a)})}getCreditsString(){return this._credits.toString()}},J=W(M),Q=z(M),b=new U;function v(s,t){if(s.isInterleavedBufferAttribute||s.array instanceof t)return s;const n=t===Int8Array||t===Int16Array||t===Int32Array?-1:0,e=new t(s.count*s.itemSize),a=new _(e,s.itemSize,!0),m=s.itemSize,l=s.count;for(let p=0;p<l;p++)for(let c=0;c<m;c++){const f=E.clamp(s.getComponent(p,c),n,1);a.setComponent(p,c,f)}return a}function k(s,t=Int16Array){const o=s.geometry,n=o.attributes,e=n.position;if(e.isInterleavedBufferAttribute||e.array instanceof t)return e;const a=new t(e.count*e.itemSize),m=new _(a,e.itemSize,!1),l=e.itemSize,p=e.count;o.computeBoundingBox();const c=o.boundingBox,{min:f,max:y}=c,u=2**(8*t.BYTES_PER_ELEMENT-1)-1,d=-u;for(let i=0;i<p;i++)for(let r=0;r<l;r++){const g=r===0?"x":r===1?"y":"z",h=f[g],x=y[g],I=E.mapLinear(e.getComponent(i,r),h,x,d,u);m.setComponent(i,r,I)}c.getCenter(b),s.position.add(b),s.scale.x*=.5*(y.x-f.x)/u,s.scale.y*=.5*(y.y-f.y)/u,s.scale.z*=.5*(y.z-f.z)/u,n.position=m,s.geometry.boundingBox=null,s.geometry.boundingSphere=null,s.updateMatrixWorld()}class Y{constructor(t){this.tiles=null,this._options={generateNormals:!1,disableMipmaps:!0,compressIndex:!0,compressNormals:!0,compressUvs:!0,compressPosition:!0,uvType:Int8Array,normalType:Int8Array,positionType:Int16Array,...t}}init(t){this.tiles=t,this._onLoadModel=({scene:o})=>{const{generateNormals:n,disableMipmaps:e,compressIndex:a,compressUvs:m,compressNormals:l,compressPosition:p,uvType:c,normalType:f,positionType:y}=this._options;o.traverse(u=>{if(u.material&&e){const d=u.material;for(const i in d){const r=d[i];r&&r.isTexture&&(r.generateMipmaps=!1)}}if(u.geometry){const d=u.geometry,i=d.attributes;if(m){const{uv:r,uv1:g,uv2:h,uv3:x}=i;r&&(i.uv=v(r,c)),g&&(i.uv1=v(g,c)),h&&(i.uv2=v(h,c)),x&&(i.uv3=v(x,c))}if(n&&!i.normals&&d.computeVertexNormals(),l&&i.normals&&(i.normals=v(i.normals,f)),p&&k(u,y),a&&d.index){const r=i.position.count,g=d.index,h=r>65535?Uint32Array:r>255?Uint16Array:Uint8Array;if(!(g.array instanceof h)){const x=new h(d.index.count);x.set(g.array);const I=new _(x,1);d.setIndex(I)}}}})},t.addEventListener("load-model",this._onLoadModel)}dispose(){this.tiles.removeEventListener("load-model",this._onLoadModel)}}export{Q as E,J as G,F as L,Y as T,w as W};
