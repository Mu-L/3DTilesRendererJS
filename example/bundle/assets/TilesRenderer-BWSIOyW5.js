import{B as we}from"./B3DMLoader-DkbFLGRR.js";import{P as Te}from"./PNTSLoader-Cb7x1xFL.js";import{I as Ce}from"./I3DMLoader-BBnK3G_T.js";import{C as Re}from"./CMPTLoader-CO2F6B4Q.js";import{G as Pe}from"./GLTFExtensionLoader-Dn4yPdlw.js";import{p as T,G as Fe,i as re,k as b,aw as oe,j as Me,B as ke,d as Ae,aq as Ie,aF as Le,E as Ue,V as $,L as Ee}from"./three.module-BB2USAyE.js";import{r as De}from"./readMagicBytes-jydveJgU.js";import{a as Ve}from"./lil-gui.module.min-D95Toaa3.js";function X(i){let e;try{e=new URL(i,"http://fakehost.com/")}catch{return null}const t=e.pathname.split("/").pop(),s=t.lastIndexOf(".");return s===-1||s===t.length-1?null:t.substring(s+1)}class Oe{get unloadPriorityCallback(){return this._unloadPriorityCallback}set unloadPriorityCallback(e){e.length===1?(console.warn('LRUCache: "unloadPriorityCallback" function has been changed to take two arguments.'),this._unloadPriorityCallback=(t,s)=>{const n=e(t),r=e(s);return n<r?-1:n>r?1:0}):this._unloadPriorityCallback=e}constructor(){this.maxSize=800,this.minSize=600,this.unloadPercent=.05,this.itemSet=new Map,this.itemList=[],this.usedSet=new Set,this.callbacks=new Map,this.markUnusedQueued=!1,this.unloadingHandle=-1,this._unloadPriorityCallback=null;const e=this.itemSet;this.defaultPriorityCallback=t=>e.get(t)}isFull(){return this.itemSet.size>=this.maxSize}add(e,t){this.markUnusedQueued&&this.markAllUnused();const s=this.itemSet;if(s.has(e)||this.isFull())return!1;const n=this.usedSet,r=this.itemList,o=this.callbacks;return r.push(e),n.add(e),s.set(e,Date.now()),o.set(e,t),!0}remove(e){const t=this.usedSet,s=this.itemSet,n=this.itemList,r=this.callbacks;if(s.has(e)){r.get(e)(e);const o=n.indexOf(e);return n.splice(o,1),t.delete(e),s.delete(e),r.delete(e),!0}return!1}markUsed(e){this.markUnusedQueued&&this.markAllUnused();const t=this.itemSet,s=this.usedSet;t.has(e)&&!s.has(e)&&(t.set(e,Date.now()),s.add(e))}markAllUnused(){this.usedSet.clear(),this.markUnusedQueued=!1,this.unloadingHandle!==-1&&(cancelAnimationFrame(this.unloadingHandle),this.unloadingHandle=-1)}unloadUnusedContent(){const e=this.unloadPercent,t=this.minSize,s=this.itemList,n=this.itemSet,r=this.usedSet,o=this.callbacks,a=s.length-r.size,l=s.length-t,c=this.unloadPriorityCallback||this.defaultPriorityCallback;let d=l;if(l>0&&a>0){s.sort((_,x)=>{const g=r.has(_),R=r.has(x);return g&&R?0:!g&&!R?-c(_,x):g?1:-1});const m=Math.min(l,a),u=Math.max(t*e,m*e);let h=Math.min(u,a);h=Math.ceil(h),d=l-h;const p=s.splice(0,h);for(let _=0,x=p.length;_<x;_++){const g=p[_];o.get(g)(g),n.delete(g),o.delete(g)}}d&&(this.unloadingHandle=requestAnimationFrame(()=>this.scheduleUnload()))}scheduleUnload(){this.scheduled||(this.scheduled=!0,queueMicrotask(()=>{this.scheduled=!1,this.unloadUnusedContent(),this.markUnusedQueued=!0}))}}class Y{constructor(){this.maxJobs=6,this.items=[],this.callbacks=new Map,this.currJobs=0,this.scheduled=!1,this.autoUpdate=!0,this.priorityCallback=()=>{throw new Error("PriorityQueue: PriorityCallback function not defined.")},this.schedulingCallback=e=>{requestAnimationFrame(e)},this._runjobs=()=>{this.tryRunJobs(),this.scheduled=!1}}sort(){const e=this.priorityCallback;this.items.sort(e)}add(e,t){return new Promise((s,n)=>{const r=(...l)=>t(...l).then(s).catch(n),o=this.items,a=this.callbacks;o.push(e),a.set(e,r),this.autoUpdate&&this.scheduleJobRun()})}remove(e){const t=this.items,s=this.callbacks,n=t.indexOf(e);n!==-1&&(t.splice(n,1),s.delete(e))}tryRunJobs(){this.sort();const e=this.items,t=this.callbacks,s=this.maxJobs;let n=this.currJobs;for(;s>n&&e.length>0;){n++;const r=e.pop(),o=t.get(r);t.delete(r),o(r).then(()=>{this.currJobs--,this.autoUpdate&&this.scheduleJobRun()}).catch(()=>{this.currJobs--,this.autoUpdate&&this.scheduleJobRun()})}this.currJobs=n}scheduleJobRun(){this.scheduled||(this.schedulingCallback(this._runjobs),this.scheduled=!0)}}const k=0,A=1,W=2,F=3,O=4,B=6378137,Be=1/298.257223563,Ne=-(Be*B-B),lt=1736*1e3,ct=1738.1*1e3;function G(i){return i===F||i===O}function C(i,e){return i.__lastFrameVisited===e&&i.__used}function ae(i,e){i.__lastFrameVisited!==e.frameCount&&(i.__lastFrameVisited=e.frameCount,i.__used=!1,i.__inFrustum=!1,i.__isLeaf=!1,i.__visible=!1,i.__active=!1,i.__error=1/0,i.__distanceFromCamera=1/0,i.__childrenWereVisible=!1,i.__allChildrenLoaded=!1,i.__inFrustum=e.tileInView(i),e.calculateError(i))}function le(i,e){if(e.ensureChildrenArePreprocessed(i),ae(i,e),ue(i,e),!i.__hasRenderableContent){const t=i.children;for(let s=0,n=t.length;s<n;s++)le(t[s],e)}}function ce(i,e){if(e.ensureChildrenArePreprocessed(i),C(i,e.frameCount)&&!i.__hasRenderableContent&&(!i.__hasUnrenderableContent||G(i.__loadingState))){const s=i.children;for(let n=0,r=s.length;n<r;n++){const o=s[n];ce(o,e)}}else e.requestTileContents(i)}function ue(i,e){i.__used=!0,e.lruCache.markUsed(i),e.stats.used++,i.__inFrustum===!0&&e.stats.inFrustum++}function ze(i,e){return!(i.__error<=e.errorTarget||e.maxDepth>0&&i.__depth+1>=e.maxDepth)}function he(i,e=null,t=null,s=null,n=0){if(e&&e(i,s,n)){t&&t(i,s,n);return}const r=i.children;for(let o=0,a=r.length;o<a;o++)he(r[o],e,t,i,n+1);t&&t(i,s,n)}function de(i,e){if(e.ensureChildrenArePreprocessed(i),ae(i,e),!i.__inFrustum||(ue(i,e),!ze(i,e)))return;let t=!1,s=!1;const n=i.children;for(let o=0,a=n.length;o<a;o++){const l=n[o];de(l,e),t=t||C(l,e.frameCount),s=s||l.__inFrustum}if(i.refine==="REPLACE"&&!s&&n.length!==0){i.__inFrustum=!1,i.__used=!1;return}const r=i.__depthFromRenderedParent===0;if(t&&i.refine==="REPLACE"&&!r)for(let o=0,a=n.length;o<a;o++){const l=n[o];le(l,e)}}function fe(i,e){const t=e.frameCount;if(!C(i,t))return;const s=i.children;let n=!1;for(let r=0,o=s.length;r<o;r++){const a=s[r];n=n||C(a,t)}if(!n)i.__isLeaf=!0;else{let r=!1,o=!0;for(let a=0,l=s.length;a<l;a++){const c=s[a];if(fe(c,e),r=r||c.__wasSetVisible||c.__childrenWereVisible,C(c,t)){const d=c.__allChildrenLoaded||c.__hasRenderableContent&&G(c.__loadingState)||!c.__hasContent&&c.children.length===0||c.__hasUnrenderableContent&&c.__loadingState===O;o=o&&d}}i.__childrenWereVisible=r,i.__allChildrenLoaded=o}}function me(i,e){const t=e.stats;if(!C(i,e.frameCount))return;const s=e.lruCache;if(i.__isLeaf){i.__loadingState===F?(i.__inFrustum&&(i.__visible=!0,t.visible++),i.__active=!0,t.active++):!s.isFull()&&i.__hasContent&&e.requestTileContents(i);return}const n=i.children,r=i.__hasContent,o=G(i.__loadingState)&&r,a=(e.errorTarget+1)*e.errorThreshold,l=i.__error<=a,c=i.__childrenWereVisible,d=i.__depthFromRenderedParent===0,m=i.__allChildrenLoaded||d;if((l||i.refine==="ADD")&&!o&&!s.isFull()&&r&&e.requestTileContents(i),(l&&!m&&!c&&o||i.refine==="ADD"&&o)&&(i.__inFrustum&&(i.__visible=!0,t.visible++),i.__active=!0,t.active++),i.refine==="REPLACE"&&l&&!m&&o)for(let h=0,p=n.length;h<p;h++){const _=n[h];C(_,e.frameCount)&&!s.isFull()&&ce(_,e)}else for(let h=0,p=n.length;h<p;h++)me(n[h],e)}function pe(i,e){const t=C(i,e.frameCount);if(t||i.__usedLastFrame){let s=!1,n=!1;t&&(s=i.__active,e.displayActiveTiles?n=i.__active||i.__visible:n=i.__visible),i.__hasRenderableContent&&i.__loadingState===F&&(i.__wasSetActive!==s&&e.setTileActive(i,s),i.__wasSetVisible!==n&&e.setTileVisible(i,n)),i.__wasSetActive=s,i.__wasSetVisible=n,i.__usedLastFrame=t;const r=i.children;for(let o=0,a=r.length;o<a;o++){const l=r[o];pe(l,e)}}}const Z=Symbol("PLUGIN_REGISTERED"),K=(i,e)=>i.__depthFromRenderedParent!==e.__depthFromRenderedParent?i.__depthFromRenderedParent>e.__depthFromRenderedParent?-1:1:i.__inFrustum!==e.__inFrustum?i.__inFrustum?1:-1:i.__used!==e.__used?i.__used?1:-1:i.__error!==e.__error?i.__error>e.__error?1:-1:i.__distanceFromCamera!==e.__distanceFromCamera?i.__distanceFromCamera>e.__distanceFromCamera?-1:1:0,We=(i,e)=>i.__depthFromRenderedParent!==e.__depthFromRenderedParent?i.__depthFromRenderedParent>e.__depthFromRenderedParent?1:-1:i.__lastFrameVisited!==e.__lastFrameVisited?i.__lastFrameVisited>e.__lastFrameVisited?-1:1:i.__hasUnrenderableContent!==e.__hasUnrenderableContent?i.__hasUnrenderableContent?-1:1:0;class je{get rootTileSet(){const e=this.tileSets[this.rootURL];return!e||e instanceof Promise?null:e}get root(){const e=this.rootTileSet;return e?e.root:null}set loadSiblings(e){console.warn('TilesRenderer: "loadSiblings" option has been removed.')}set stopAtEmptyTiles(e){console.warn('TilesRenderer: "stopAtEmptyTiles" option has been removed.')}constructor(e=null){this.tileSets={},this.rootURL=e,this.fetchOptions={},this.plugins=[],this.preprocessURL=null;const t=new Oe;t.unloadPriorityCallback=We;const s=new Y;s.maxJobs=4,s.priorityCallback=K;const n=new Y;n.maxJobs=1,n.priorityCallback=K,this.lruCache=t,this.downloadQueue=s,this.parseQueue=n,this.stats={parsing:0,downloading:0,failed:0,inFrustum:0,used:0,active:0,visible:0},this.frameCount=0,this.errorTarget=6,this.errorThreshold=1/0,this.displayActiveTiles=!1,this.maxDepth=1/0}registerPlugin(e){if(e[Z]===!0)throw new Error("TilesRendererBase: A plugin can only be registered to a single tile set");this.plugins.push(e),e[Z]=!0,e.init(this)}getPluginByName(e){return this.plugins.find(t=>t.name===e)}traverse(e,t){const n=this.tileSets[this.rootURL];!n||!n.root||he(n.root,(r,...o)=>(this.ensureChildrenArePreprocessed(r),e?e(r,...o):!1),t)}update(){const e=this.stats,t=this.lruCache,s=this.tileSets,n=s[this.rootURL];if(this.rootURL in s){if(!n||!n.root)return}else{this.invokeOnePlugin(o=>o.loadRootTileSet&&o.loadRootTileSet(this.rootURL));return}const r=n.root;e.inFrustum=0,e.used=0,e.active=0,e.visible=0,this.frameCount++,de(r,this),fe(r,this),me(r,this),pe(r,this),t.scheduleUnload()}resetFailedTiles(){const e=this.stats;e.failed!==0&&(this.traverse(t=>{t.__loadingState===O&&(t.__loadingState=k)}),e.failed=0)}dispose(){this.invokeAllPlugins(s=>{s!==this&&s.dispose&&s.dispose()});const e=this.lruCache,t=[];this.traverse(s=>(t.push(s),!1));for(let s=0,n=t.length;s<n;s++)e.remove(t[s]);this.stats={parsing:0,downloading:0,failed:0,inFrustum:0,used:0,active:0,visible:0},this.frameCount=0}parseTile(e,t,s){return null}disposeTile(e){}preprocessNode(e,t,s=null){if(e.content&&(!("uri"in e.content)&&"url"in e.content&&(e.content.uri=e.content.url,delete e.content.url),e.content.uri&&(e.content.uri=new URL(e.content.uri,t+"/").toString()),e.content.boundingVolume&&!("box"in e.content.boundingVolume||"sphere"in e.content.boundingVolume||"region"in e.content.boundingVolume)&&delete e.content.boundingVolume),e.parent=s,e.children=e.children||[],e.content&&e.content.uri){const r=X(e.content.uri);e.__hasContent=!0,e.__hasUnrenderableContent=!!(r&&/json$/.test(r)),e.__hasRenderableContent=!e.__hasUnrenderableContent}else e.__hasContent=!1,e.__hasUnrenderableContent=!1,e.__hasRenderableContent=!1;e.__distanceFromCamera=1/0,e.__error=1/0,e.__inFrustum=!1,e.__isLeaf=!1,e.__usedLastFrame=!1,e.__used=!1,e.__wasSetVisible=!1,e.__visible=!1,e.__childrenWereVisible=!1,e.__allChildrenLoaded=!1,e.__wasSetActive=!1,e.__active=!1,e.__loadingState=k,e.__loadIndex=0,e.__loadAbort=null,s===null?(e.__depth=0,e.__depthFromRenderedParent=0,e.refine=e.refine||"REPLACE"):(e.__depth=s.__depth+1,e.__depthFromRenderedParent=s.__depthFromRenderedParent+(e.__hasRenderableContent?1:0),e.refine=e.refine||s.refine),e.__basePath=t,e.__lastFrameVisited=-1}setTileActive(e,t){}setTileVisible(e,t){}calculateError(e){return 0}tileInView(e){return!0}ensureChildrenArePreprocessed(e){const t=e.children;for(let s=0,n=t.length;s<n;s++){const r=t[s];if("__depth"in r)break;this.preprocessNode(r,e.__basePath,e)}}fetchTileSet(e,t,s=null){return fetch(e,t).then(n=>{if(n.ok)return n.json();throw new Error(`TilesRenderer: Failed to load tileset "${e}" with status ${n.status} : ${n.statusText}`)}).then(n=>{const r=n.asset.version,[o,a]=r.split(".").map(c=>parseInt(c));console.assert(o<=1,"TilesRenderer: asset.version is expected to be a 1.x or a compatible version."),o===1&&a>0&&console.warn("TilesRenderer: tiles versions at 1.1 or higher have limited support. Some new extensions and features may not be supported.");let l=e.replace(/\/[^/]*\/?$/,"");return l=new URL(l,window.location.href).toString(),this.preprocessNode(n.root,l,s),n})}loadRootTileSet(e){const t=this.tileSets;if(e in t)return t[e]instanceof Error?Promise.reject(t[e]):Promise.resolve(t[e]);{let s=e;this.invokeAllPlugins(r=>s=r.preprocessURL?r.preprocessURL(s):s);const n=this.fetchTileSet(s,this.fetchOptions).then(r=>{t[e]=r});return n.catch(r=>{console.error(r),t[e]=r}),t[e]=n,n}}requestTileContents(e){if(e.__loadingState!==k)return;const t=this.stats,s=this.lruCache,n=this.downloadQueue,r=this.parseQueue,o=e.__hasUnrenderableContent;if(!s.add(e,u=>{u.__loadingState===A?(u.__loadAbort.abort(),u.__loadAbort=null):o?u.children.length=0:this.disposeTile(u),u.__loadingState===A?t.downloading--:u.__loadingState===W&&t.parsing--,u.__loadingState=k,u.__loadIndex++,r.remove(u),n.remove(u)}))return;e.__loadIndex++;const l=e.__loadIndex,c=new AbortController,d=c.signal;t.downloading++,e.__loadAbort=c,e.__loadingState=A;const m=u=>{e.__loadIndex===l&&(u.name!=="AbortError"?(r.remove(e),n.remove(e),e.__loadingState===W?t.parsing--:e.__loadingState===A&&t.downloading--,t.failed++,console.error(`TilesRenderer : Failed to load tile at url "${e.content.uri}".`),console.error(u),e.__loadingState=O):s.remove(e))};o?n.add(e,u=>{if(u.__loadIndex!==l)return Promise.resolve();let h=u.content.uri;return this.invokeAllPlugins(p=>h=p.preprocessURL?p.preprocessURL(h):h),this.fetchTileSet(h,Object.assign({signal:d},this.fetchOptions),u)}).then(u=>{e.__loadIndex===l&&(t.downloading--,e.__loadAbort=null,e.__loadingState=F,e.children.push(u.root))}).catch(m):n.add(e,u=>{if(u.__loadIndex!==l)return Promise.resolve();let h=u.content.uri;return this.invokeAllPlugins(p=>h=p.preprocessURL?p.preprocessURL(h):h),fetch(h,Object.assign({signal:d},this.fetchOptions))}).then(u=>{if(e.__loadIndex===l){if(u.ok)return u.arrayBuffer();throw new Error(`Failed to load model with error code ${u.status}`)}}).then(u=>{if(e.__loadIndex===l)return t.downloading--,t.parsing++,e.__loadAbort=null,e.__loadingState=W,r.add(e,h=>{if(h.__loadIndex!==l)return Promise.resolve();const p=h.content.uri,_=X(p);return this.parseTile(u,h,_)})}).then(()=>{e.__loadIndex===l&&(t.parsing--,e.__loadingState=F,e.__wasSetVisible&&this.setTileVisible(e,!0),e.__wasSetActive&&this.setTileActive(e,!0))}).catch(m)}invokeOnePlugin(e){const t=[...this.plugins,this];for(let s=0;s<t.length;s++){const n=e(t[s]);if(n)return n}return null}invokeAllPlugins(e){const t=[...this.plugins,this],s=[];for(let n=0;n<t.length;n++){const r=e(t[n]);r&&s.push(r)}return s.length===0?null:Promise.all(s)}}const I=new T;class qe extends Fe{constructor(e){super(),this.name="TilesRenderer.TilesGroup",this.tilesRenderer=e}raycast(e,t){return this.tilesRenderer.optimizeRaycast?(this.tilesRenderer.raycast(e,t),!1):!0}updateMatrixWorld(e){if(this.matrixAutoUpdate&&this.updateMatrix(),this.matrixWorldNeedsUpdate||e){this.parent===null?I.copy(this.matrix):I.multiplyMatrices(this.parent.matrixWorld,this.matrix),this.matrixWorldNeedsUpdate=!1;const t=I.elements,s=this.matrixWorld.elements;let n=!1;for(let r=0;r<16;r++){const o=t[r],a=s[r];if(Math.abs(o-a)>Number.EPSILON){n=!0;break}}if(n){this.matrixWorld.copy(I);const r=this.children;for(let o=0,a=r.length;o<a;o++)r[o].updateMatrixWorld()}}}}const Ge=parseInt(oe)<165,N=new T,_e=new re,j=new b,V=[];function ge(i,e){return i.distance-e.distance}function be(i,e,t){Ge?(i.traverse(s=>{Object.getPrototypeOf(s).raycast.call(s,e,t)}),V.sort(ge)):e.intersectObject(i,!0,t)}function Je(i,e){be(i,e,V);const t=V[0]||null;return V.length=0,t}function xe(i,e,t,s=null){const{group:n,activeTiles:r}=i;i.ensureChildrenArePreprocessed(e),s===null&&(s=_e,N.copy(n.matrixWorld).invert(),s.copy(t.ray).applyMatrix4(N));const o=[],a=e.children;for(let d=0,m=a.length;d<m;d++){const u=a[d];if(!u.__used)continue;u.cached.boundingVolume.intersectRay(s,j)!==null&&(j.applyMatrix4(n.matrixWorld),o.push({distance:j.distanceToSquared(t.ray.origin),tile:u}))}o.sort(ge);let l=null,c=1/0;if(r.has(e)){const d=Je(e.cached.scene,t);d&&(l=d,c=d.distance*d.distance)}for(let d=0,m=o.length;d<m;d++){const u=o[d],h=u.distance,p=u.tile;if(h>c)break;const _=xe(i,p,t,s);if(_){const x=_.distance*_.distance;x<c&&(l=_,c=x)}}return l}function ye(i,e,t,s,n=null){const{group:r,activeTiles:o}=i,{scene:a,boundingVolume:l}=e.cached;if(i.ensureChildrenArePreprocessed(e),n===null&&(n=_e,N.copy(r.matrixWorld).invert(),n.copy(t.ray).applyMatrix4(N)),!e.__used||!l.intersectsRay(n))return;o.has(e)&&be(a,t,s);const c=e.children;for(let d=0,m=c.length;d<m;d++)ye(i,c[d],t,s,n)}const L=new b,U=new b,y=new b,E=new re;class ee{constructor(e=new ke,t=new T){this.box=e.clone(),this.transform=t.clone(),this.inverseTransform=new T,this.points=new Array(8).fill().map(()=>new b),this.planes=new Array(6).fill().map(()=>new Me)}clampPoint(e,t){return t.copy(e).applyMatrix4(this.inverseTransform).clamp(this.box.min,this.box.max).applyMatrix4(this.transform)}distanceToPoint(e){return this.clampPoint(e,y).distanceTo(e)}containsPoint(e){return y.copy(e).applyMatrix4(this.inverseTransform),this.box.containsPoint(y)}intersectsRay(e){return E.copy(e).applyMatrix4(this.inverseTransform),E.intersectsBox(this.box)}intersectRay(e,t){return E.copy(e).applyMatrix4(this.inverseTransform),E.intersectBox(this.box,t)?(t.applyMatrix4(this.transform),t):null}update(){const{points:e,inverseTransform:t,transform:s,box:n}=this;t.copy(s).invert();const{min:r,max:o}=n;let a=0;for(let l=-1;l<=1;l+=2)for(let c=-1;c<=1;c+=2)for(let d=-1;d<=1;d+=2)e[a].set(l<0?r.x:o.x,c<0?r.y:o.y,d<0?r.z:o.z).applyMatrix4(s),a++;this.updatePlanes()}updatePlanes(){L.copy(this.box.min).applyMatrix4(this.transform),U.copy(this.box.max).applyMatrix4(this.transform),y.set(0,0,1).transformDirection(this.transform),this.planes[0].setFromNormalAndCoplanarPoint(y,L),this.planes[1].setFromNormalAndCoplanarPoint(y,U).negate(),y.set(0,1,0).transformDirection(this.transform),this.planes[2].setFromNormalAndCoplanarPoint(y,L),this.planes[3].setFromNormalAndCoplanarPoint(y,U).negate(),y.set(1,0,0).transformDirection(this.transform),this.planes[4].setFromNormalAndCoplanarPoint(y,L),this.planes[5].setFromNormalAndCoplanarPoint(y,U).negate()}intersectsFrustum(e){const{points:t}=this,{planes:s}=e;for(let n=0;n<6;n++){const r=s[n];let o=-1/0;for(let a=0;a<8;a++){const l=t[a],c=r.distanceToPoint(l);o=o<c?c:o}if(o<0)return!1}for(let n=0;n<6;n++){const r=this.planes[n];let o=-1/0;for(let a=0;a<8;a++){const l=e.points[a],c=r.distanceToPoint(l);o=o<c?c:o}if(o<0)return!1}return!0}}const S=new b,v=new b,w=new b,te=new b,se=new b;class Qe{constructor(){this.sphere=null,this.obb=null,this.region=null,this.regionObb=null}intersectsRay(e){const t=this.sphere,s=this.obb||this.regionObb;return!(t&&!e.intersectsSphere(t)||s&&!s.intersectRay(e))}intersectRay(e,t=null){const s=this.sphere,n=this.obb||this.regionObb;let r=-1/0,o=-1/0;s&&e.intersectSphere(s,te)&&(r=s.containsPoint(e.origin)?0:e.origin.distanceToSquared(te)),n&&n.intersectRay(e,se)&&(o=n.containsPoint(e.origin)?0:e.origin.distanceToSquared(se));const a=Math.max(r,o);return a===-1/0?null:(e.at(Math.sqrt(a),t),t)}distanceToPoint(e){const t=this.sphere,s=this.obb||this.regionObb;let n=-1/0,r=-1/0;return t&&(n=Math.max(t.distanceToPoint(e),0)),s&&(r=s.distanceToPoint(e)),n>r?n:r}intersectsFrustum(e){const t=this.obb||this.regionObb,s=this.sphere;return s&&!e.intersectsSphere(s)||t&&!t.intersectsFrustum(e)?!1:!!(s||t)}getOBB(e,t){const s=this.obb||this.regionObb;s?(e.copy(s.box),t.copy(s.transform)):(this.getAABB(e),t.identity())}getAABB(e){if(this.sphere)this.sphere.getBoundingBox(e);else{const t=this.obb||this.regionObb;e.copy(t.box).applyMatrix4(t.transform)}}getSphere(e){if(this.sphere)e.copy(this.sphere);else if(this.region)this.region.getBoundingSphere(e);else{const t=this.obb||this.regionObb;t.box.getBoundingSphere(e),e.applyMatrix4(t.transform)}}setObbData(e,t){const s=new ee;S.set(e[3],e[4],e[5]),v.set(e[6],e[7],e[8]),w.set(e[9],e[10],e[11]);const n=S.length(),r=v.length(),o=w.length();S.normalize(),v.normalize(),w.normalize(),n===0&&S.crossVectors(v,w),r===0&&v.crossVectors(S,w),o===0&&w.crossVectors(S,v),s.transform.set(S.x,v.x,w.x,e[0],S.y,v.y,w.y,e[1],S.z,v.z,w.z,e[2],0,0,0,1).premultiply(t),s.box.min.set(-n,-r,-o),s.box.max.set(n,r,o),s.update(),this.obb=s}setSphereData(e,t,s,n,r){const o=new Ae;o.center.set(e,t,s),o.radius=n,o.applyMatrix4(r),this.sphere=o}setRegionData(e,t,s,n,r,o){const a=new Ve(B,B,Ne,t,n,e,s,r,o),l=new ee;a.getBoundingBox(l.box,l.transform),l.update(),this.region=a,this.regionObb=l}}const He=new Ie;function $e(i,e,t,s){const n=He.set(i.normal.x,i.normal.y,i.normal.z,e.normal.x,e.normal.y,e.normal.z,t.normal.x,t.normal.y,t.normal.z);return s.set(-i.constant,-e.constant,-t.constant),s.applyMatrix3(n.invert()),s}class Xe extends Le{constructor(){super(),this.points=Array(8).fill().map(()=>new b)}setFromProjectionMatrix(e,t){super.setFromProjectionMatrix(e,t),this.calculateFrustumPoints()}calculateFrustumPoints(){const{planes:e,points:t}=this;[[e[0],e[3],e[4]],[e[1],e[3],e[4]],[e[0],e[2],e[4]],[e[1],e[2],e[4]],[e[0],e[3],e[5]],[e[1],e[3],e[5]],[e[0],e[2],e[5]],[e[1],e[2],e[5]]].forEach((n,r)=>{$e(n[0],n[1],n[2],t[r])})}}const ne=parseInt(oe)<165,Se=Symbol("INITIAL_FRUSTUM_CULLED"),D=new T,q=new T,P=new b,Ye=new b(1,0,0),Ze=new b(0,1,0);function ie(i,e){i.traverse(t=>{t.frustumCulled=t[Se]&&e})}class Ke extends je{get autoDisableRendererCulling(){return this._autoDisableRendererCulling}set autoDisableRendererCulling(e){this._autoDisableRendererCulling!==e&&(super._autoDisableRendererCulling=e,this.forEachLoadedModel(t=>{ie(t,!e)}))}constructor(...e){super(...e),this.group=new qe(this),this.cameras=[],this.cameraMap=new Map,this.cameraInfo=[],this.activeTiles=new Set,this.visibleTiles=new Set,this.optimizeRaycast=!0,this._eventDispatcher=new Ue,this._upRotationMatrix=new T,this._autoDisableRendererCulling=!0,this._loadingTiles=!1;const t=new Ee;if(t.setURLModifier(s=>this.preprocessURL?this.preprocessURL(s):s),this.manager=t,ne){const s=this;this._overridenRaycast=function(n,r){s.optimizeRaycast||Object.getPrototypeOf(this).raycast.call(this,n,r)}}}addEventListener(...e){this._eventDispatcher.addEventListener(...e)}hasEventListener(...e){this._eventDispatcher.hasEventListener(...e)}removeEventListener(...e){this._eventDispatcher.removeEventListener(...e)}dispatchEvent(...e){this._eventDispatcher.dispatchEvent(...e)}getBounds(...e){return console.warn("TilesRenderer: getBounds has been renamed to getBoundingBox."),this.getBoundingBox(...e)}getOrientedBounds(...e){return console.warn("TilesRenderer: getOrientedBounds has been renamed to getOrientedBoundingBox."),this.getOrientedBoundingBox(...e)}getBoundingBox(e){if(!this.root)return!1;const t=this.root.cached.boundingVolume;return t?(t.getAABB(e),!0):!1}getOrientedBoundingBox(e,t){if(!this.root)return!1;const s=this.root.cached.boundingVolume;return s?(s.getOBB(e,t),!0):!1}getBoundingSphere(e){if(!this.root)return!1;const t=this.root.cached.boundingVolume;return t?(t.getSphere(e),!0):!1}forEachLoadedModel(e){this.traverse(t=>{const s=t.cached.scene;s&&e(s,t)})}raycast(e,t){if(this.root)if(e.firstHitOnly){const s=xe(this,this.root,e);s&&t.push(s)}else ye(this,this.root,e,t)}hasCamera(e){return this.cameraMap.has(e)}setCamera(e){const t=this.cameras,s=this.cameraMap;return s.has(e)?!1:(s.set(e,new $),t.push(e),this.dispatchEvent({type:"add-camera",camera:e}),!0)}setResolution(e,t,s){const n=this.cameraMap;return n.has(e)?(t instanceof $?n.get(e).copy(t):n.get(e).set(t,s),!0):!1}setResolutionFromRenderer(e,t){const s=this.cameraMap;if(!s.has(e))return!1;const n=s.get(e);return t.getSize(n),n.multiplyScalar(t.getPixelRatio()),!0}deleteCamera(e){const t=this.cameras,s=this.cameraMap;if(s.has(e)){const n=t.indexOf(e);return t.splice(n,1),s.delete(e),this.dispatchEvent({type:"delete-camera",camera:e}),!0}return!1}fetchTileSet(e,...t){const s=super.fetchTileSet(e,...t);return s.then(n=>{queueMicrotask(()=>{this.dispatchEvent({type:"load-tile-set",tileSet:n,url:e})})}).catch(()=>{}),s}loadRootTileSet(...e){return super.loadRootTileSet(...e).then(()=>{switch((this.rootTileSet.asset&&this.rootTileSet.asset.gltfUpAxis||"y").toLowerCase()){case"x":this._upRotationMatrix.makeRotationAxis(Ze,-Math.PI/2);break;case"y":this._upRotationMatrix.makeRotationAxis(Ye,Math.PI/2);break}}).catch(()=>{})}update(){this.dispatchEvent({type:"update-before"});const e=this.group,t=this.cameras,s=this.cameraMap,n=this.cameraInfo;if(t.length===0){console.warn("TilesRenderer: no cameras defined. Cannot update 3d tiles.");return}for(;n.length>t.length;)n.pop();for(;n.length<t.length;)n.push({frustum:new Xe,isOrthographic:!1,sseDenominator:-1,position:new b,invScale:-1,pixelSize:0});q.copy(e.matrixWorld).invert(),P.setFromMatrixScale(q);const r=P.x;Math.abs(Math.max(P.x-P.y,P.x-P.z))>1e-6&&console.warn("ThreeTilesRenderer : Non uniform scale used for tile which may cause issues when calculating screen space error.");for(let o=0,a=n.length;o<a;o++){const l=t[o],c=n[o],d=c.frustum,m=c.position,u=s.get(l);(u.width===0||u.height===0)&&console.warn("TilesRenderer: resolution for camera error calculation is not set.");const h=l.projectionMatrix.elements;if(c.isOrthographic=h[15]===1,c.isOrthographic){const p=2/h[0],_=2/h[5];c.pixelSize=Math.max(_/u.height,p/u.width)}else c.sseDenominator=2/h[5]/u.height;c.invScale=r,D.copy(e.matrixWorld),D.premultiply(l.matrixWorldInverse),D.premultiply(l.projectionMatrix),d.setFromProjectionMatrix(D),m.set(0,0,0),m.applyMatrix4(l.matrixWorld),m.applyMatrix4(q)}super.update(),this.dispatchEvent({type:"update-after"})}preprocessNode(e,t,s=null){super.preprocessNode(e,t,s);const n=new T;if(e.transform){const a=e.transform;for(let l=0;l<16;l++)n.elements[l]=a[l]}s&&n.premultiply(s.cached.transform);const r=new T().copy(n).invert(),o=new Qe;"sphere"in e.boundingVolume&&o.setSphereData(...e.boundingVolume.sphere,n),"box"in e.boundingVolume&&o.setObbData(e.boundingVolume.box,n),"region"in e.boundingVolume&&o.setRegionData(...e.boundingVolume.region),e.cached={_loadIndex:0,transform:n,transformInverse:r,active:!1,boundingVolume:o,metadata:null,scene:null,geometry:null,materials:null,textures:null}}async parseTile(e,t,s){const n=t.cached;n._loadIndex++;const o=t.content.uri.split(/[\\/]/g);o.pop();const a=o.join("/"),l=this.fetchOptions,c=this.manager,d=n._loadIndex;let m=null;const u=n.transform,h=this._upRotationMatrix,p=(De(e)||s).toLowerCase();switch(p){case"b3dm":{const f=new we(c);f.workingPath=a,f.fetchOptions=l,f.adjustmentTransform.copy(h),m=f.parse(e);break}case"pnts":{const f=new Te(c);f.workingPath=a,f.fetchOptions=l,m=f.parse(e);break}case"i3dm":{const f=new Ce(c);f.workingPath=a,f.fetchOptions=l,f.adjustmentTransform.copy(h),m=f.parse(e);break}case"cmpt":{const f=new Re(c);f.workingPath=a,f.fetchOptions=l,f.adjustmentTransform.copy(h),m=f.parse(e).then(M=>M.scene);break}case"gltf":case"glb":{const f=new Pe(c);f.workingPath=a,f.fetchOptions=l,m=f.parse(e);break}default:console.warn(`TilesRenderer: Content type "${p}" not supported.`),m=Promise.resolve(null);break}const _=this.stats;this._loadingTiles===!1&&_.parsing+_.downloading>0&&(this.dispatchEvent({type:"tiles-load-start"}),this._loadingTiles=!0);const x=await m;let g,R;if(x.isObject3D?(g=x,R=null):(g=x.scene,R=x),await this.invokeAllPlugins(f=>f.processTileModel&&f.processTileModel(g,t)),n._loadIndex!==d)return;g.updateMatrix(),(p==="glb"||p==="gltf")&&g.matrix.multiply(h),g.matrix.premultiply(u),g.matrix.decompose(g.position,g.quaternion,g.scale),g.traverse(f=>{f[Se]=f.frustumCulled}),ie(g,!this.autoDisableRendererCulling),ne&&g.traverse(f=>{f.raycast=this._overridenRaycast});const J=[],Q=[],H=[];g.traverse(f=>{if(f.geometry&&Q.push(f.geometry),f.material){const M=f.material;J.push(f.material);for(const ve in M){const z=M[ve];z&&z.isTexture&&H.push(z)}}}),n.materials=J,n.geometry=Q,n.textures=H,n.scene=g,n.metadata=R,this.dispatchEvent({type:"load-model",scene:g,tile:t}),this._loadingTiles===!0&&_.parsing+_.downloading===1&&(this.dispatchEvent({type:"tiles-load-end"}),this._loadingTiles=!1)}disposeTile(e){const t=e.cached;if(t.scene){const s=t.materials,n=t.geometry,r=t.textures,o=t.scene.parent;t.scene.traverse(a=>{a.userData.meshFeatures&&a.userData.meshFeatures.dispose(),a.userData.structuralMetadata&&a.userData.structuralMetadata.dispose()});for(let a=0,l=n.length;a<l;a++)n[a].dispose();for(let a=0,l=s.length;a<l;a++)s[a].dispose();for(let a=0,l=r.length;a<l;a++){const c=r[a];c.image instanceof ImageBitmap&&c.image.close(),c.dispose()}o&&o.remove(t.scene),this.dispatchEvent({type:"dispose-model",scene:t.scene,tile:e}),t.scene=null,t.materials=null,t.textures=null,t.geometry=null,t.metadata=null}this.activeTiles.delete(e),this.visibleTiles.delete(e),t._loadIndex++}setTileVisible(e,t){const s=e.cached.scene,n=this.visibleTiles,r=this.group;t?(r.add(s),n.add(e),s.updateMatrixWorld(!0)):(r.remove(s),n.delete(e)),this.dispatchEvent({type:"tile-visibility-change",scene:s,tile:e,visible:t})}setTileActive(e,t){const s=this.activeTiles;t?s.add(e):s.delete(e)}calculateError(e){const t=e.cached,s=this.cameras,n=this.cameraInfo,r=t.boundingVolume;let o=-1/0,a=1/0;for(let l=0,c=s.length;l<c;l++){const d=n[l],m=d.invScale;let u;if(d.isOrthographic){const h=d.pixelSize;u=e.geometricError/(h*m)}else{const p=r.distanceToPoint(d.position)*m,_=d.sseDenominator;u=e.geometricError/(p*_),a=Math.min(a,p)}o=Math.max(o,u)}e.__distanceFromCamera=a,e.__error=o}tileInView(e){const s=e.cached.boundingVolume,n=this.cameraInfo;for(let r=0,o=n.length;r<o;r++){const a=n[r].frustum;if(s.intersectsFrustum(a))return!0}return!1}}[["onLoadTileSet","load-tile-set"],["onLoadModel","load-model"],["onDisposeModel","dispose-model"],["onTileVisibilityChange","tile-visibility-change"]].forEach(([i,e])=>{const t=Symbol(i);Object.defineProperty(Ke.prototype,i,{get(){return this[t]||null},set(s){console.warn(`TilesRenderer: "${i}" has been deprecated in favor of the "${e}" event.`),this[t]&&this.removeEventListener(e,this[t]),this[t]=s,this.addEventListener(e,s)}})});export{ct as L,Y as P,Ke as T,B as W,Ne as a,lt as b};
