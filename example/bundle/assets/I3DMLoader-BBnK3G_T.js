import{r as V,F as H,B as G,a as v}from"./readMagicBytes-jydveJgU.js";import{L as Q}from"./LoaderBase-QLlipkOW.js";import{k as d,p as B,aG as k,aH as $,Q as j}from"./three.module-BB2USAyE.js";import{G as z}from"./GLTFLoader-_VBLdhWf.js";class W extends Q{parse(a){const n=new DataView(a),r=V(n);console.assert(r==="i3dm");const N=n.getUint32(4,!0);console.assert(N===1);const A=n.getUint32(8,!0);console.assert(A===a.byteLength);const b=n.getUint32(12,!0),E=n.getUint32(16,!0),c=n.getUint32(20,!0),g=n.getUint32(24,!0),f=n.getUint32(28,!0),T=32,S=a.slice(T,T+b+E),s=new H(S,0,b,E),t=T+b+E,l=a.slice(t,t+c+g),L=new G(l,s.getData("INSTANCES_LENGTH"),0,c,g),p=t+c+g,h=new Uint8Array(a,p,A-p);let m=null,o=null;if(f)m=h,o=Promise.resolve();else{const u=this.resolveExternalURL(v(h));o=fetch(u,this.fetchOptions).then(i=>{if(!i.ok)throw new Error(`I3DMLoaderBase : Failed to load file "${u}" with status ${i.status} : ${i.statusText}`);return i.arrayBuffer()}).then(i=>{m=new Uint8Array(i)})}return o.then(()=>({version:N,featureTable:s,batchTable:L,glbBytes:m}))}}const C=new d,I=new d,_=new d,F=new d,R=new j,U=new d,M=new B,D=new B;class X extends W{constructor(a=k){super(),this.manager=a,this.adjustmentTransform=new B}resolveExternalURL(a){return this.manager.resolveURL(super.resolveExternalURL(a))}parse(a){return super.parse(a).then(n=>{const{featureTable:r,batchTable:N}=n,A=n.glbBytes.slice().buffer;return new Promise((b,E)=>{const c=this.fetchOptions,g=this.manager,f=g.getHandler("path.gltf")||new z(g);c.credentials==="include"&&c.mode==="cors"&&f.setCrossOrigin("use-credentials"),"credentials"in c&&f.setWithCredentials(c.credentials==="include"),c.headers&&f.setRequestHeader(c.headers);let T=this.workingPath;/[\\/]$/.test(T)||(T+="/");const S=this.adjustmentTransform;f.parse(A,T,s=>{const t=r.getData("INSTANCES_LENGTH"),l=r.getData("POSITION",t,"FLOAT","VEC3"),L=r.getData("NORMAL_UP",t,"FLOAT","VEC3"),p=r.getData("NORMAL_RIGHT",t,"FLOAT","VEC3"),h=r.getData("SCALE_NON_UNIFORM",t,"FLOAT","VEC3"),m=r.getData("SCALE",t,"FLOAT","SCALAR");["RTC_CENTER","QUANTIZED_VOLUME_OFFSET","QUANTIZED_VOLUME_SCALE","EAST_NORTH_UP","POSITION_QUANTIZED","NORMAL_UP_OCT32P","NORMAL_RIGHT_OCT32P"].forEach(e=>{e in r.header&&console.warn(`I3DMLoader: Unsupported FeatureTable feature "${e}" detected.`)});const o=new d;for(let e=0;e<t;e++)o.x+=l[e*3+0]/t,o.y+=l[e*3+1]/t,o.z+=l[e*3+2]/t;const u=[],i=[];s.scene.updateMatrixWorld(),s.scene.traverse(e=>{if(e.isMesh){i.push(e);const{geometry:O,material:y}=e,w=new $(O,y,t);w.position.copy(o),u.push(w)}});for(let e=0;e<t;e++){F.set(l[e*3+0]-o.x,l[e*3+1]-o.y,l[e*3+2]-o.z),L?(I.set(L[e*3+0],L[e*3+1],L[e*3+2]),_.set(p[e*3+0],p[e*3+1],p[e*3+2]),C.crossVectors(_,I).normalize(),M.makeBasis(_,I,C),R.setFromRotationMatrix(M)):R.set(0,0,0,1),m?U.setScalar(m[e]):h?U.set(h[e*3+0],h[e*3+1],h[e*3+2]):U.set(1,1,1),M.compose(F,R,U).multiply(S);for(let O=0,y=u.length;O<y;O++){const w=u[O],P=i[O];D.multiplyMatrices(M,P.matrixWorld),w.setMatrixAt(e,D)}}s.scene.clear(),s.scene.add(...u),s.batchTable=N,s.featureTable=r,s.scene.batchTable=N,s.scene.featureTable=r,b(s)},E)})})}}export{X as I};
